name: Integration Tests

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
      - master

jobs:
  infra-backed-tests:
    name: Infra-backed Integration Suite
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: rahul
          POSTGRES_PASSWORD: ci_password
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U rahul -d postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
      kafka:
        image: bitnami/kafka:3.7
        ports:
          - 9092:9092
        env:
          ALLOW_PLAINTEXT_LISTENER: "yes"
          KAFKA_CFG_NODE_ID: "0"
          KAFKA_CFG_PROCESS_ROLES: "controller,broker"
          KAFKA_CFG_LISTENERS: "PLAINTEXT://:9092,CONTROLLER://:9093"
          KAFKA_CFG_ADVERTISED_LISTENERS: "PLAINTEXT://localhost:9092"
          KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT"
          KAFKA_CFG_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
          KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: "0@kafka:9093"
    env:
      SPRING_PROFILES_ACTIVE: test
      SPRING_FLYWAY_ENABLED: "false"
      SPRING_JPA_HIBERNATE_DDL_AUTO: create-drop
      JWT_SECRET: ci-jwt-secret-32-bytes-minimum-value-for-tests-123456
      STRIPE_SECRET_KEY: sk_test_ci_placeholder
      STRIPE_WEBHOOK_SECRET: whsec_ci_placeholder
      TEST_POSTGRES_PASSWORD: ci_password
      POSTGRES_PASSWORD: ci_password
      EUREKA_CLIENT_ENABLED: "false"
      EUREKA_CLIENT_REGISTER_WITH_EUREKA: "false"
      EUREKA_CLIENT_FETCH_REGISTRY: "false"
      SPRING_CLOUD_DISCOVERY_ENABLED: "false"
      SPRING_CLOUD_GATEWAY_DISCOVERY_LOCATOR_ENABLED: "false"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Install infra clients
        run: sudo apt-get update && sudo apt-get install -y postgresql-client redis-tools netcat-openbsd

      - name: Wait for PostgreSQL and Redis
        run: |
          until pg_isready -h localhost -p 5432 -U rahul; do
            echo "Waiting for Postgres..."
            sleep 2
          done
          until redis-cli -h localhost -p 6379 ping | grep -q PONG; do
            echo "Waiting for Redis..."
            sleep 2
          done

      - name: Wait for Kafka
        run: |
          for i in {1..60}; do
            if nc -z localhost 9092; then
              echo "Kafka is reachable on 9092"
              exit 0
            fi
            echo "Waiting for Kafka..."
            sleep 2
          done
          echo "Kafka was not reachable within timeout"
          exit 1

      - name: Initialize databases
        run: |
          psql "postgresql://rahul:ci_password@localhost:5432/postgres" -c "CREATE DATABASE payment_db;"
          psql "postgresql://rahul:ci_password@localhost:5432/postgres" -c "CREATE DATABASE payment_db_test;"
          psql "postgresql://rahul:ci_password@localhost:5432/postgres" -c "CREATE DATABASE fraud_db;"
          psql "postgresql://rahul:ci_password@localhost:5432/postgres" -c "CREATE DATABASE ledger_db;"
          psql "postgresql://rahul:ci_password@localhost:5432/postgres" -c "CREATE DATABASE settlement_db;"
          psql "postgresql://rahul:ci_password@localhost:5432/postgres" -c "CREATE DATABASE notification_db;"
          psql "postgresql://rahul:ci_password@localhost:5432/postgres" -c "CREATE DATABASE merchant_db;"

      - name: Run integration-focused backend tests
        run: >
          mvn -B -ntp
          -pl payment-service,fraud-service,ledger-service,settlement-service,notification-service,merchant-service
          -am test
          -DfailIfNoTests=false
          -Dsurefire.rerunFailingTestsCount=1
